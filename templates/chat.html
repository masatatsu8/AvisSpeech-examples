<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>メイドチャット</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>

<body>
    <div class="container">
        <div class="sidebar">
            <h2 style="text-align: center; text-decoration: none;"><a href="/"
                    style="text-decoration: none;">メイドチャット</a></h2>
            <button onclick="createNewChat()" class="new-chat-button">新しい会話を始める</button>
            <div class="chat-list">
                {% for chat_item in chats %}
                <div class="chat-item {% if chat_item.id == chat.id %}active{% endif %}">
                    <span class="chat-title" data-chat-id="{{ chat_item.id }}"
                        onclick="handleClick(event, {{ chat_item.id }})"
                        ondblclick="handleDoubleClick(event, this, {{ chat_item.id }})">
                        {{ chat_item.title }}
                    </span>
                    <span class="chat-menu-trigger" onclick="showChatMenu(event, {{ chat_item.id }})">⋮</span>
                    <div class="chat-menu" id="chat-menu-{{ chat_item.id }}">
                        <div class="chat-menu-item" onclick="handleRename(event, {{ chat_item.id }})">名称変更</div>
                        <div class="chat-menu-item" onclick="handleDelete(event, {{ chat_item.id }})">削除</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <div class="main-content">
            <img src="/static/images/maid_chat.jpeg" alt="メイドチャット" class="banner">
            <div class="chat-container">
                <div id="chat-messages" class="chat-messages">
                    {% for message in messages %}
                    <div class="message {% if message.role == 'assistant' %}assistant{% else %}user{% endif %}"
                        data-message-id="{{ message.id }}"
                        oncontextmenu="showContextMenu(event, {{ message.id }}); return false;">
                        {% if message.role == 'assistant' %}
                        <img src="/static/images/maid_icon.png" class="maid-icon" alt="メイド">
                        {% endif %}
                        <div class="message-content">{{ message.content }}</div>
                    </div>
                    {% endfor %}
                </div>
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="メッセージを入力してください...">
                    <button id="send-button">送信</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 右クリックメニュー -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" onclick="deleteMessage()">削除</div>
    </div>

    <script>
        let clickTimer = null;
        let preventClick = false;
        let activeChatMenu = null;

        function handleClick(event, chatId) {
            if (event.target.classList.contains('chat-title-input')) {
                return;
            }
            if (preventClick) {
                preventClick = false;
                return;
            }

            if (clickTimer === null) {
                clickTimer = setTimeout(function () {
                    clickTimer = null;
                    window.location.href = `/chat/${chatId}`;
                }, 200);
            }
        }

        function handleDoubleClick(event, element, chatId) {
            event.preventDefault();
            event.stopPropagation();
            if (event.target.classList.contains('chat-title-input')) {
                return;
            }
            if (clickTimer) {
                clearTimeout(clickTimer);
                clickTimer = null;
            }
            preventClick = true;
            startEditing(element, chatId);
        }

        function editTitle(element, chatId) {
            const currentTitle = element.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'chat-title-input';

            // 入力欄がクリックされたときにイベントの伝播を防ぐ
            input.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
            };

            // 入力欄でEnterキーが押されたときの処理
            input.onkeydown = async function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    await updateTitle(input.value.trim(), currentTitle, element, chatId);
                }
            };

            // 入力欄からフォーカスが外れたときの処理
            input.onblur = async function (e) {
                await updateTitle(input.value.trim(), currentTitle, element, chatId);
            };

            element.style.display = 'none';
            element.parentNode.insertBefore(input, element);
            input.focus();
            input.select();
        }

        async function updateTitle(newTitle, currentTitle, element, chatId) {
            if (newTitle && newTitle !== currentTitle) {
                try {
                    const response = await fetch(`/chat/${chatId}/title`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ title: newTitle })
                    });
                    if (response.ok) {
                        element.textContent = newTitle;
                    } else {
                        console.error('Error updating title:', await response.text());
                        element.textContent = currentTitle;
                    }
                } catch (error) {
                    console.error('Error updating title:', error);
                    element.textContent = currentTitle;
                }
            } else {
                element.textContent = currentTitle;
            }
            element.style.display = '';
            element.parentNode.querySelector('.chat-title-input')?.remove();
        }

        // チャットメニューを表示
        function showChatMenu(event, chatId) {
            event.stopPropagation();

            // 他のメニューを閉じる
            if (activeChatMenu && activeChatMenu !== `chat-menu-${chatId}`) {
                document.getElementById(activeChatMenu).style.display = 'none';
            }

            const menu = document.getElementById(`chat-menu-${chatId}`);
            const display = menu.style.display;
            menu.style.display = display === 'block' ? 'none' : 'block';
            activeChatMenu = display === 'block' ? null : `chat-menu-${chatId}`;
        }

        // チャットの名称変更
        function handleRename(event, chatId) {
            event.stopPropagation();
            const chatItem = event.target.closest('.chat-item');
            const titleSpan = chatItem.querySelector('.chat-title');
            startEditing(titleSpan, chatId);
            hideChatMenu(chatId);
        }

        // チャットの削除
        async function handleDelete(event, chatId) {
            event.stopPropagation();

            if (!confirm('このチャットを削除してもよろしいですか？')) {
                hideChatMenu(chatId);
                return;
            }

            try {
                const response = await fetch(`/chats/${chatId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.next_chat_id) {
                        window.location.href = `/chat/${data.next_chat_id}`;
                    } else {
                        window.location.href = '/';  // 会話が一つもない場合はトップページへ
                    }
                } else {
                    alert('チャットの削除に失敗しました');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('チャットの削除に失敗しました');
            }

            hideChatMenu(chatId);
        }

        // チャットメニューを非表示
        function hideChatMenu(chatId) {
            const menu = document.getElementById(`chat-menu-${chatId}`);
            if (menu) {
                menu.style.display = 'none';
                activeChatMenu = null;
            }
        }

        // 名称変更の開始
        function startEditing(element, chatId) {
            const currentTitle = element.textContent.trim();
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTitle;
            input.className = 'chat-title-input';

            input.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
            };

            input.onkeydown = async function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.stopPropagation();
                    await updateTitle(input.value.trim(), currentTitle, element, chatId);
                }
            };

            input.onblur = async function (e) {
                await updateTitle(input.value.trim(), currentTitle, element, chatId);
            };

            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
        }

        // ページ読み込み時に最下部にスクロール
        document.addEventListener('DOMContentLoaded', function () {
            scrollToBottom(true);
        });

        function scrollToBottom(force = false) {
            const chatMessages = document.getElementById('chat-messages');
            const lastMessage = chatMessages.lastElementChild;
            if (lastMessage) {
                if (force) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                } else {
                    const lastMessageRect = lastMessage.getBoundingClientRect();
                    const containerRect = chatMessages.getBoundingClientRect();
                    const bottomOffset = containerRect.bottom - lastMessageRect.bottom;

                    if (bottomOffset < 100) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }
            }
        }

        let ws = new WebSocket(`ws://${window.location.host}/ws/{{ chat.id }}`);
        let currentMaidMessage = null;

        ws.onmessage = function (event) {
            const data = JSON.parse(event.data);

            if (data.type === 'partial') {
                if (!currentMaidMessage) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'message assistant';
                    messageDiv.innerHTML = `
                        <img src="/static/images/maid_icon.png" class="maid-icon" alt="メイド">
                        <div class="message-content"></div>
                    `;
                    document.getElementById('chat-messages').appendChild(messageDiv);
                    currentMaidMessage = messageDiv.querySelector('.message-content');
                    scrollToBottom();
                }

                currentMaidMessage.textContent += data.text;
                scrollToBottom();
            } else if (data.type === 'complete') {
                currentMaidMessage = null;
                scrollToBottom();
            }
        };

        document.getElementById('send-button').addEventListener('click', sendMessage);

        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();

            if (message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-content">${message}</div>
                `;
                document.getElementById('chat-messages').appendChild(messageDiv);

                ws.send(message);
                messageInput.value = '';
                scrollToBottom();
            }
        }

        document.getElementById('message-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendMessage();
            }
        });

        let selectedMessageId = null;

        // 右クリックメニューを表示
        function showContextMenu(event, messageId) {
            event.preventDefault();
            selectedMessageId = messageId;

            const menu = document.getElementById('context-menu');
            menu.style.display = 'block';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
        }

        // メッセージを削除
        async function deleteMessage() {
            if (!selectedMessageId) return;

            if (!confirm('このメッセージを削除してもよろしいですか？')) {
                hideContextMenu();
                return;
            }

            try {
                const response = await fetch(`/messages/${selectedMessageId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const messageElement = document.querySelector(`[data-message-id="${selectedMessageId}"]`);
                    if (messageElement) {
                        messageElement.remove();
                    }
                } else {
                    alert('メッセージの削除に失敗しました');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('メッセージの削除に失敗しました');
            }

            hideContextMenu();
        }

        // 右クリックメニューを非表示
        function hideContextMenu() {
            const menu = document.getElementById('context-menu');
            menu.style.display = 'none';
            selectedMessageId = null;
        }

        // 画面のどこかをクリックしたら右クリックメニューを非表示
        document.addEventListener('click', function (event) {
            if (!event.target.closest('#context-menu')) {
                hideContextMenu();
            }
        });

        // 画面のどこかをクリックしたらチャットメニューを非表示
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.chat-menu') && !event.target.closest('.chat-menu-trigger')) {
                const menus = document.querySelectorAll('.chat-menu');
                menus.forEach(menu => menu.style.display = 'none');
                activeChatMenu = null;
            }
        });

        async function createNewChat() {
            try {
                const response = await fetch('/chat/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    redirect: 'follow'
                });
                
                if (response.redirected) {
                    window.location.href = response.url;
                } else if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
            } catch (error) {
                console.error('Error creating new chat:', error);
                alert('会話の作成中にエラーが発生しました。もう一度お試しください。');
            }
        }
    </script>
</body>

</html>